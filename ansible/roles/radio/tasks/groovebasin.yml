---

# Because there is no debian npm package. wtf. T_T
- name: Install nodesource signing key
  apt_key:
    url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
    state: present

# groovebasin will run on node 8 but not node 10
- name: Install nodesource repo
  apt_repository:
    repo: deb https://deb.nodesource.com/node_8.x stretch main
    state: present

- name: Install node and npm
  apt: pkg=nodejs state=latest update_cache=yes

- name: Install groovebasin deps
  apt: pkg={{ item }} state=present
  with_items:
    - libgroove-dev
    - libgrooveplayer-dev
    - libgrooveloudness-dev
    - libgroovefingerprinter-dev

- name: Make groovebasin dir
  file: path=/srv/www/{{ groovebasin_domain }} state=directory
    owner={{ groovebasin_user }} group=www-data

- name: Checkout groovebasin
  git: repo=git://github.com/andrewrk/groovebasin.git
    dest=/srv/www/{{ groovebasin_domain }} accept_hostkey=yes
  become_user: "{{ groovebasin_user }}"

- name: Fetch dependencies
  shell: npm run build
  args:
    chdir: /srv/www/{{ groovebasin_domain }}
  become_user: "{{ groovebasin_user }}"

- name: Configure Groovebasin
  template: src=groovebasin.j2 dest=/srv/www/{{ groovebasin_domain }}/config.json
    owner={{ groovebasin_user}} group={{ groovebasin_user }}
