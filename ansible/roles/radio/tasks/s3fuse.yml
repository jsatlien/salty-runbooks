---

- name: Install s3fs
  apt: pkg=s3fs state=present

- name: Add s3fs auth file
  template: src=s3fs.j2 dest=/etc/passwd-s3fs mode=600

- name: Create mountpoint
  file: path={{ item.path }} state=directory owner={{ groovebasin_user }} group={{ groovebasin_user }}
  with_items: "{{ s3_mountpoints }}"

- name: Create cache
  file: path={{ item.cache }} state=directory owner={{ groovebasin_user }} group={{ groovebasin_user }}
  with_items: "{{ s3_mountpoints }}"

- name: Add any mountpoints to fstab
  mount: name={{ item.path }} state=mounted fstype=fuse src='s3fs#{{ item.bucket }}'
    opts="allow_other,uid=radio,gid=radio,use_cache={{ item.cache }},max_stat_cache_size=40000"
  with_items: "{{ s3_mountpoints }}"
